{% extends 'base.html' %}
{% load static %}
{% block body %}

    <a onclick="noBack()" href="{% url 'login_error' %}"></a>
    <div class="pcoded-content">
        <div class="page-header card">
            <div class="row align-items-end">
                <div class="col-lg-8">
                    <div class="page-header-title">
                        <div class="d-inline">
                            <h5><a href="{% url 'contractor/users' %}"><i
                                    class="icofont icofont-simple-left"></i></a>{{ first_name }}&nbsp;{{ last_name }}
                            </h5>
                        </div>
                    </div>
                </div>
                <div class="col-lg-4">

                </div>
            </div>
        </div>
        <div class="page-header card">
            <div class="card">
                <div class="card-block">
                    <div class="user-prof-one-part clearfix">
                        <div class="image">
                            <img src="{{ MEDIA_URL }}{{ image }}" alt="image not found">
                            <!--<div class="text-center p-t-20" id="unblock_block_user">

                                {% if is_blocked %}
                                    <button type="button" data-url="{% url 'ublock' user_id %}" id="unblock_user"
                                            class="btn btn-danger  text-center waves-effect text-center user_unblock"
                                            onclick="unblock()" title="User is blocked click here to unblock User">
                                        Unblock
                                    </button>
                                {% else %}
                                    <button type="button" id="block_user" data-url="{% url 'ublock' user_id %}"
                                            class="btn btn-primary  text-center waves-effect text-center user_block"
                                            onclick="block()"
                                            title="User is Unblocked click here to block User">Block
                                    </button>
                                {% endif %}
                            </div>-->

                        </div>
                        <div class="text v-product-top">
                            <div class="row">
                                <div class="col-xl-8 col-lg-12 col-sm-12">
                                    <div class="form-group row">
                                        <label class="col-sm-4 col-form-label">First Name</label>
                                        <div class="col-sm-8">
                                            <h4>{{ first_name }}</h4>
                                        </div>
                                    </div>
                                </div>
                            </div>
                            <div class="row">
                                <div class="col-xl-8 col-lg-12 col-sm-12">
                                    <div class="form-group row">
                                        <label class="col-sm-4 col-form-label">Last Name</label>
                                        <div class="col-sm-8">
                                            <h4>{{ last_name }}</h4>
                                        </div>
                                    </div>
                                </div>
                            </div>
                            <div class="row">
                                <div class="col-xl-8 col-lg-12 col-sm-12">
                                    <div class="form-group row">
                                        <label class="col-sm-4 col-form-label">Email Address</label>
                                        <div class="col-sm-8">
                                            <h4>{{ email }}</h4>
                                        </div>
                                    </div>
                                </div>
                            </div>
                            <div class="row">
                                <div class="col-xl-8 col-lg-12 col-sm-12">
                                    <div class="form-group row">
                                        <label class="col-sm-4 col-form-label">Telephone Number</label>
                                        <div class="col-sm-8">
                                            <h4>{{ phone }}</h4>
                                        </div>
                                    </div>
                                </div>
                            </div>
                            <div class="row">
                                <div class="col-xl-8 col-lg-12 col-sm-12">
                                    <div class="form-group row">
                                        <label class="col-sm-4 col-form-label EarnedPoints">Total Earned Points</label>
                                        <div class="col-sm-8">
                                            <h4>{{ lifetime_earned_points }}</h4>
                                        </div>
                                    </div>
                                </div>
                            </div>
                            <div class="row">
                                <div class="col-xl-8 col-lg-12 col-sm-12">
                                    <div class="form-group row">
                                        <label class="col-sm-4 col-form-label">Available Points</label>
                                        <div class="col-sm-8">
                                            <h4>{{ available_points }}</h4>
                                        </div>
                                    </div>
                                </div>

                            </div>

                        </div>
                    </div>
                </div>
            </div>
            <div class="page-header-title p-b-15">
                <div class="d-inline">
                    <h5>User Information</h5>
                </div>
            </div>
            <div class="card">
                <div class="card-block">

                    <div class="v-product-top">
                        <div class="row">
                            <div class="col-xl-6 col-lg-12 col-sm-12">
                                <div class="form-group row">
                                    <label class="col-sm-4 col-form-label">Company Name</label>
                                    <div class="col-sm-8">
                                        <h4>{{ company_name }}</h4>
                                    </div>
                                </div>
                            </div>
                            <div class="col-xl-6 col-lg-12 col-sm-12">
                                <div class="form-group row">
                                    <label class="col-sm-4 col-form-label">Country</label>
                                    <div class="col-sm-8">
                                        <h4>{{ country }}</h4>
                                    </div>
                                </div>
                            </div>
                        </div>
                        <div class="row">
                            <div class="col-xl-6 col-lg-12 col-sm-12">
                                <div class="form-group row">
                                    <label class="col-sm-4 col-form-label">Address</label>
                                    <div class="col-sm-8">
                                        <h4>{{ add_line1 }}</h4>
                                    </div>
                                </div>
                            </div>
                            <div class="col-xl-6 col-lg-12 col-sm-12">
                                <div class="form-group row">
                                    <label class="col-sm-4 col-form-label">Zip Code</label>
                                    <div class="col-sm-8">
                                        <h4>{{ zip_code }}</h4>
                                    </div>
                                </div>
                            </div>
                        </div>
                        <div class="row">
                            <div class="col-xl-6 col-lg-12 col-sm-12">
                                <div class="form-group row">
                                    <label class="col-sm-4 col-form-label">City</label>
                                    <div class="col-sm-8">
                                        <h4>{{ city }}</h4>
                                    </div>
                                </div>
                            </div>
                            <div class="col-xl-6 col-lg-12 col-sm-12">
                                <div class="form-group row">
                                    <label class="col-sm-4 col-form-label">Refer Code</label>
                                    <div class="col-sm-8">
                                        <h4>{{ referral_code }}</h4>
                                    </div>
                                </div>
                            </div>
                        </div>
                        <div class="row">
                            <div class="col-xl-6 col-lg-12 col-sm-12">
                                <div class="form-group row">
                                    <label class="col-sm-4 col-form-label">State</label>
                                    <div class="col-sm-8">
                                        <h4>{{ state }}</h4>
                                    </div>
                                </div>
                            </div>
                            <div class="col-xl-6 col-lg-12 col-sm-12">
                                <div class="form-group row">
                                    <label class="col-sm-4 col-form-label">Refer By</label>
                                    <div class="col-sm-8">
                                        <h4>{{ referred }}</h4>
                                    </div>
                                </div>
                            </div>
                        </div>

                    </div>
                </div>
            </div>

            <div class="page-header p-b-15">
                <div class="row align-items-end">
                    <div class="col-lg-8">
                        <div class="page-header-title">
                            <div class="d-inline">
                                <h5>Scanned QR Codes</h5>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
            <a href="#" title="Add Points" 
            data-toggle="modal" data-target="#add-points"
            class="tabledit-edit-button btn btn-primary waves-light waves-effect"><i
                class="icofont icofont-plus"></i></a>
            <div class="card">
                <div class="card-block">
                    <div class="dt-responsive table-responsive">
                        <table id="multi-colum-dt-qr-con" class="table table-striped table-bordered nowrap">
                            <thead>
                                <tr>
                                    <th>Date Time</th>
                                    <th>QR Code</th>
                                    <th>Earned Points</th>
                                    <th>QR Status</th>
                                    <th>Location</th>
                                    <th>Weather Information</th>
                                    <th>Action</th>
                                  </tr>
                                </thead>
                                <tbody>
                                {% for x in data %}
                                <tr>
                                    <td>{{ x.created_at }}</td>
                                    <td>{{ x.qr_code.qr_image }}</td>
                                    <td>{{ x.product_point }}</td>                      <td>{{ x.qr_status }}</td>
                                    <td class="location_{{forloop.counter }}">{{ x.qr_code.scanned_location }}</td>
                                    <td><span>Humidity : {% if x.qr_code.humidity %} {{ x.qr_code.humidity }} % {% endif %}</span><br><span> Wind Speed : {% if x.qr_code.wind_speed %} {{ x.qr_code.wind_speed }} m/s {% endif %}</span><br><span> Temperature : {% if x.qr_code.temp %} {{ x.qr_code.temp }} °F {% endif %}</td>
                                    <td>
                                    <a href="{% url 'con_qrcode/' id=x.id   %}" class="tabledit-edit-button btn btn-primary waves-light waves-effect" title="View"><i class="icofont icofont-eye-alt"></i></a>
                                    </td>
                                </tr>
                                {% endfor %}
                            </tbody>
                        </table>
                    </div>
                </div>
            </div>
            <div class="page-header p-b-15">
                <div class="row align-items-end">
                    <div class="col-lg-8">
                        <div class="page-header-title">
                            <div class="d-inline">
                                <h5>Reward History</h5>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
            <div class="card">
                <div class="card-block">
                    <div class="dt-responsive table-responsive">
                        <table id="multi-colum-dt76" class="table table-striped table-bordered nowrap">
                            <thead>
                            <tr>
                                <th>Date and Time</th>
                                <th>QR Code</th>
                                <th>Earned Points</th>
                                <th>Splited</th>
                                <th>Points-Type</th>
                                <th>Reward-Type</th>
                                <th>Reason</th>
                            </tr>
                            </thead>
                            {% for created,reward,splitted,reward_type,qr_id,points_type,admin_reason in comb %}
                                <tr>
                                    <td>{{ created }}</td>
                                    <td>{{ qr_id }}</td>
                                    <td>{{ reward }}</td>
                                    {% if splitted %}
                                        <td> YES</td> {% else %}
                                        <td> No</td> {% endif %}
                                    <td>{{ points_type }}</td>
                                    <td>{{ reward_type }}</td>
                                    <td>{{ admin_reason }}</td>
                                </tr>
                            {% endfor %}
                        </table>
                    </div>
                </div>
            </div>

            <!-- <div class="page-header p-b-15">
                <div class="row align-items-end">
                    <div class="col-lg-8">
                        <div class="page-header-title">
                            <div class="d-inline">
                                <h5>Assigned Tasks</h5>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <div class="card">
                <div class="card-block">
                    <div class="dt-responsive table-responsive">
                        <table id="multi-colum-dt-merchant_details" class="table table-striped table-bordered nowrap">
                            <thead>
                            <tr>
                                <th>Job Category</th>
                                <th>Description</th>
                                <th>Task Status</th>
                            </tr>
                            </thead>
                            <tbody>
                            {% for task in tasks %}
                                <tr>
                                    <td>{{ task.assigned_job.job_category_name }}</td>
                                    <td>{{ task.description }}</td>
                                    <td>{{ task.task_status }}</td>
                                </tr>
                            {% endfor %}
                            </tbody>
                        </table>
                    </div>
                </div>
            </div> -->


        </div>
    </div>

    <script type="text/javascript" src="{% static 'js/jquery.min.js' %}"></script>
    <script src="https://unpkg.com/sweetalert/dist/sweetalert.min.js"></script>
    <script src="{% static 'js/data-table-custom.js' %}" type="text/javascript"></script>
<script type="text/javascript" src="{% static 'js/jquery.dataTables.min.js' %}"></script>
<script src="{% static 'js/dataTables.buttons.min.js' %}" type="text/javascript"></script>
<script src="{% static 'js/dataTables.bootstrap4.min.js' %}" type="text/javascript"></script>
<script src="{% static 'js/dataTables.responsive.min.js' %}" type="text/javascript"></script>
<!-- <link rel="stylesheet" type="text/css" href="https://cdnjs.cloudflare.com/ajax/libs/sweetalert/1.1.3/sweetalert.min.css"> -->
<script src="https://cdnjs.cloudflare.com/ajax/libs/limonte-sweetalert2/8.11.8/sweetalert2.all.min.js"></script>

<div class="modal fade" id="add-points" tabindex="-1" role="dialog">
    <div class="modal-dialog modal-sm custome-modal" role="document">
        <div class="modal-content p-l-20 p-r-20 p-t-15">
            <div class="modal-body text-center">

                <h4>Add Points</h4>
                <div class="row">
                    <!-- <div class="col-md-4 col-xs-12">
                        <label>Manufacturer <span style="color:red;">* : </span></label>
                    </div>
                    <div class="col-md-8 col-xs-12 mb-10">
                        <input id="p_id" type="text" class="form-control" name="" placeholder="" hidden value="">
                        <input id="m_name" type="text" class="form-control" name="" placeholder="" disabled>
                    </div>
                    <div class="col-md-4 col-xs-12">
                        <label>Product Name <span style="color:red;">* : </span></label>
                    </div>
                    <div class="col-md-8 col-xs-12 mb-10">
                        <input id="p_name" type="text" class="form-control" name="" placeholder="" disabled>
                    </div>
                    <div class="col-md-4 col-xs-12">
                        <label>Product Points <span style="color:red;">* : </span></label></div>
                    <div class="col-md-8 col-xs-12 mb-10">
                        <input id="p_points" type="text" class="form-control" name="" placeholder="" disabled>
                    </div> -->
                    <div class="col-md-4 col-xs-12">
                        <label>Additional Points</label>&nbsp;<span style="color:red;">*</span></div>
                    <div class="col-md-8 col-xs-12 ">
                        <input id="addln_points" type="number" class="form-control your_class" name=""
                               placeholder="" min="0">
                    </div>
                </div>
            </div>
            <div class="modal-footer">
                <button type="submit" class="btn btn-primary waves-effect waves-light"
                        onclick="showDollarPrice($(this).attr('data-url'))" id="points_submit"
                        data-url= "{% url 'contractor/prediction/points/usd' %}">Submit
                </button>
                <button type="button" class="btn btn-default waves-effect" data-dismiss="modal">Cancel</button>
            </div>
        </div>
    </div>
</div>
<!--</form>-->


    <script type="text/javascript">
        window.history.forward();

        function noBack() {
            window.history.forward();
        }
    </script>
<script type="text/javascript">
    $(document).ready(function(){
        var htmlSpan = '<span></span>';
        console.log('htmlSpan-------->',htmlSpan)
        // var i = 0;
        var flag = 0;
        console.log("$('td').parent().length----------",$('td').parent().length)
        for(var i=1; i <= $('td').parent().length; i++){
            console.log('i------>',i)
            var fullLocation = $('.location_'+i).text()
            console.log('fullLocation---------->',fullLocation)
            var splitFullLocation = fullLocation.split(',')
            console.log('splitFullLocation--------->',splitFullLocation,'splitFullLocation.length-------->',splitFullLocation.length)
            for(var j = 0; j<splitFullLocation.length; j++){
                if(j != splitFullLocation.length - 1) {
                    console.log('if------')
                    htmlSpan += '<span>'+splitFullLocation[j]+','+splitFullLocation[j+1]+'.</span><br>'
                } else {
                    console.log('else------')
                    htmlSpan += '<span>'+splitFullLocation[j]+'.</span><br>'
                }
                console.log('append htmlSpan------',htmlSpan)
                $('.location_'+i).html(htmlSpan)
                $('.location_'+i).css('text-align: inherit;')
                j=j+1;
                console.log('j=j+2----------',j)
            }
            htmlSpan = '<span></span>'
            console.log('final htmlSpan-------',htmlSpan)
        }
    });
</script>    



<script>

    function showDollarPrice(url) {
        pid = $('#p_id').val();
        addln_points = $('#addln_points').val();
        console.log('url : ', url, "addln_points : ", addln_points, "pid : ", pid);

        $.ajax({
            url: url,
            type: "GET",
            dataType: 'json',
            data: {
                'points': addln_points
            },
            success: function (data) {
                expected_bill = data['returned_dollar'];
                console.log('success data : ', data['returned_dollar']);

                const swalWithBootstrapButtons = Swal.mixin({
                    customClass: {
                        confirmButton: 'btn btn-success',
                        cancelButton: 'btn btn-danger',
                    },
                    buttonsStyling: false
                })


                swalWithBootstrapButtons.fire({
                    title: 'Are you sure?',
                    text: " You want to add " + addln_points + " additional points in user account",
                    type: 'warning',
                    showCancelButton: true,
                    confirmButtonText: 'Yes, do it!',
                    cancelButtonText: 'No, cancel!',
                    reverseButtons: true
                }).then((result) => {
                    console.log('result--', result.value, result)
                    if (result.value) {

                        $.ajax({
                            url: url + '/',
                            type: 'POST',
                            data: {
                                'addln_points': addln_points,
                                'expected_bill': expected_bill,
                                'product_id': pid
                            },
                            success: function (data) {
                                console.log('success')
                                swalWithBootstrapButtons.fire(
                                    'Request Sent!',
                                    'Your request for adding points in product is successfully sent to admin.',
                                    'success',
                                )
                                if ($('.swal2-confirm').html() == 'OK') {
                                    $('.swal2-confirm').css('display', 'none');
                                }

                                function redirect() {
                                    window.location.href = "{% url 'contractor/products'  %}";
                                }

                                setTimeout(redirect, 2000); //2000 is equivalent to 2 seconds
                            },

                        });
                    }

                })


            }
        });

    }

    document.querySelector(".your_class").addEventListener("keypress", function (evt) {
        if (evt.which != 8 && evt.which != 0 && evt.which < 48 || evt.which > 57) {
            evt.preventDefault();
        }
    });
</script>
{% endblock %}